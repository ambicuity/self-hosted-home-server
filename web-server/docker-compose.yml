version: '3.8'

# Web Server Stack
# NGINX: Static sites | WordPress: CMS | Ghost: Modern publishing

services:
  # NGINX - Static website hosting
  nginx:
    image: nginx:alpine
    container_name: nginx-web
    restart: unless-stopped
    networks:
      - proxy
    volumes:
      - ./sites:/usr/share/nginx/html:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nginx-web.entrypoints=http"
      - "traefik.http.routers.nginx-web.rule=Host(`www.${DOMAIN}`)"
      - "traefik.http.middlewares.nginx-web-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.nginx-web.middlewares=nginx-web-https-redirect"
      - "traefik.http.routers.nginx-web-secure.entrypoints=https"
      - "traefik.http.routers.nginx-web-secure.rule=Host(`www.${DOMAIN}`)"
      - "traefik.http.routers.nginx-web-secure.tls=true"
      - "traefik.http.routers.nginx-web-secure.service=nginx-web"
      - "traefik.http.services.nginx-web.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"

  # WordPress - Content management system
  wordpress:
    image: wordpress:latest
    container_name: wordpress
    restart: unless-stopped
    networks:
      - proxy
      - webserver
    depends_on:
      - wordpress-db
    environment:
      - WORDPRESS_DB_HOST=wordpress-db
      - WORDPRESS_DB_NAME=wordpress
      - WORDPRESS_DB_USER=wordpress
      - WORDPRESS_DB_PASSWORD=${WP_DB_PASSWORD}
    volumes:
      - wordpress-data:/var/www/html
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wordpress.entrypoints=http"
      - "traefik.http.routers.wordpress.rule=Host(`blog.${DOMAIN}`)"
      - "traefik.http.middlewares.wordpress-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.wordpress.middlewares=wordpress-https-redirect"
      - "traefik.http.routers.wordpress-secure.entrypoints=https"
      - "traefik.http.routers.wordpress-secure.rule=Host(`blog.${DOMAIN}`)"
      - "traefik.http.routers.wordpress-secure.tls=true"
      - "traefik.http.routers.wordpress-secure.service=wordpress"
      - "traefik.http.services.wordpress.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"

  wordpress-db:
    image: mysql:8
    container_name: wordpress-db
    restart: unless-stopped
    networks:
      - webserver
    environment:
      - MYSQL_ROOT_PASSWORD=${WP_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=wordpress
      - MYSQL_PASSWORD=${WP_DB_PASSWORD}
    volumes:
      - wordpress-db:/var/lib/mysql
    command: '--default-authentication-plugin=mysql_native_password'

  # Ghost - Modern publishing platform
  ghost:
    image: ghost:latest
    container_name: ghost
    restart: unless-stopped
    networks:
      - proxy
      - webserver
    depends_on:
      - ghost-db
    environment:
      - url=https://ghost.${DOMAIN}
      - database__client=mysql
      - database__connection__host=ghost-db
      - database__connection__user=ghost
      - database__connection__password=${GHOST_DB_PASSWORD}
      - database__connection__database=ghost
    volumes:
      - ghost-data:/var/lib/ghost/content
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ghost.entrypoints=http"
      - "traefik.http.routers.ghost.rule=Host(`ghost.${DOMAIN}`)"
      - "traefik.http.middlewares.ghost-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.ghost.middlewares=ghost-https-redirect"
      - "traefik.http.routers.ghost-secure.entrypoints=https"
      - "traefik.http.routers.ghost-secure.rule=Host(`ghost.${DOMAIN}`)"
      - "traefik.http.routers.ghost-secure.tls=true"
      - "traefik.http.routers.ghost-secure.service=ghost"
      - "traefik.http.services.ghost.loadbalancer.server.port=2368"
      - "traefik.docker.network=proxy"

  ghost-db:
    image: mysql:8
    container_name: ghost-db
    restart: unless-stopped
    networks:
      - webserver
    environment:
      - MYSQL_ROOT_PASSWORD=${GHOST_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=ghost
      - MYSQL_USER=ghost
      - MYSQL_PASSWORD=${GHOST_DB_PASSWORD}
    volumes:
      - ghost-db:/var/lib/mysql

  # Hugo - Static site generator server
  hugo:
    image: klakegg/hugo:alpine
    container_name: hugo
    restart: unless-stopped
    networks:
      - proxy
    command: server --bind=0.0.0.0 --baseURL=https://hugo.${DOMAIN}
    volumes:
      - ${HUGO_SITE_PATH}:/src
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hugo.entrypoints=http"
      - "traefik.http.routers.hugo.rule=Host(`hugo.${DOMAIN}`)"
      - "traefik.http.middlewares.hugo-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.hugo.middlewares=hugo-https-redirect"
      - "traefik.http.routers.hugo-secure.entrypoints=https"
      - "traefik.http.routers.hugo-secure.rule=Host(`hugo.${DOMAIN}`)"
      - "traefik.http.routers.hugo-secure.tls=true"
      - "traefik.http.routers.hugo-secure.service=hugo"
      - "traefik.http.services.hugo.loadbalancer.server.port=1313"
      - "traefik.docker.network=proxy"

networks:
  proxy:
    external: true
  webserver:
    driver: bridge

volumes:
  wordpress-data:
  wordpress-db:
  ghost-data:
  ghost-db:

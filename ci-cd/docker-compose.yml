version: '3.8'

# CI/CD Stack
# Gitea: Lightweight Git service | Drone: CI/CD platform | Jenkins: Automation server

services:
  # Gitea - Self-hosted Git service
  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    restart: unless-stopped
    networks:
      - proxy
      - cicd
    depends_on:
      - gitea-db
    environment:
      - USER_UID=${PUID}
      - USER_GID=${PGID}
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=gitea-db:5432
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=${GITEA_DB_PASSWORD}
      - GITEA__server__DOMAIN=git.${DOMAIN}
      - GITEA__server__SSH_DOMAIN=git.${DOMAIN}
      - GITEA__server__ROOT_URL=https://git.${DOMAIN}
    volumes:
      - gitea-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "2222:22"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitea.entrypoints=http"
      - "traefik.http.routers.gitea.rule=Host(`git.${DOMAIN}`)"
      - "traefik.http.middlewares.gitea-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.gitea.middlewares=gitea-https-redirect"
      - "traefik.http.routers.gitea-secure.entrypoints=https"
      - "traefik.http.routers.gitea-secure.rule=Host(`git.${DOMAIN}`)"
      - "traefik.http.routers.gitea-secure.tls=true"
      - "traefik.http.routers.gitea-secure.service=gitea"
      - "traefik.http.services.gitea.loadbalancer.server.port=3000"
      - "traefik.docker.network=proxy"

  gitea-db:
    image: postgres:15-alpine
    container_name: gitea-db
    restart: unless-stopped
    networks:
      - cicd
    environment:
      - POSTGRES_USER=gitea
      - POSTGRES_PASSWORD=${GITEA_DB_PASSWORD}
      - POSTGRES_DB=gitea
    volumes:
      - gitea-db:/var/lib/postgresql/data

  # Drone Server - CI/CD platform
  drone:
    image: drone/drone:latest
    container_name: drone
    restart: unless-stopped
    networks:
      - proxy
      - cicd
    depends_on:
      - gitea
    environment:
      - DRONE_GITEA_SERVER=https://git.${DOMAIN}
      - DRONE_GITEA_CLIENT_ID=${DRONE_GITEA_CLIENT_ID}
      - DRONE_GITEA_CLIENT_SECRET=${DRONE_GITEA_CLIENT_SECRET}
      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}
      - DRONE_SERVER_HOST=drone.${DOMAIN}
      - DRONE_SERVER_PROTO=https
      - DRONE_USER_CREATE=username:${DRONE_ADMIN_USER},admin:true
    volumes:
      - drone-data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.drone.entrypoints=http"
      - "traefik.http.routers.drone.rule=Host(`drone.${DOMAIN}`)"
      - "traefik.http.middlewares.drone-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.drone.middlewares=drone-https-redirect"
      - "traefik.http.routers.drone-secure.entrypoints=https"
      - "traefik.http.routers.drone-secure.rule=Host(`drone.${DOMAIN}`)"
      - "traefik.http.routers.drone-secure.tls=true"
      - "traefik.http.routers.drone-secure.service=drone"
      - "traefik.http.services.drone.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"

  # Drone Runner - Execute CI/CD pipelines
  drone-runner:
    image: drone/drone-runner-docker:latest
    container_name: drone-runner
    restart: unless-stopped
    networks:
      - cicd
    depends_on:
      - drone
    environment:
      - DRONE_RPC_PROTO=https
      - DRONE_RPC_HOST=drone.${DOMAIN}
      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}
      - DRONE_RUNNER_CAPACITY=2
      - DRONE_RUNNER_NAME=home-runner
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # Jenkins - Automation server
  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins
    restart: unless-stopped
    networks:
      - proxy
      - cicd
    environment:
      - JENKINS_OPTS=--prefix=/jenkins
    volumes:
      - jenkins-data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    user: root
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jenkins.entrypoints=http"
      - "traefik.http.routers.jenkins.rule=Host(`jenkins.${DOMAIN}`)"
      - "traefik.http.middlewares.jenkins-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.jenkins.middlewares=jenkins-https-redirect"
      - "traefik.http.routers.jenkins-secure.entrypoints=https"
      - "traefik.http.routers.jenkins-secure.rule=Host(`jenkins.${DOMAIN}`)"
      - "traefik.http.routers.jenkins-secure.tls=true"
      - "traefik.http.routers.jenkins-secure.service=jenkins"
      - "traefik.http.services.jenkins.loadbalancer.server.port=8080"
      - "traefik.docker.network=proxy"

networks:
  proxy:
    external: true
  cicd:
    driver: bridge

volumes:
  gitea-data:
  gitea-db:
  drone-data:
  jenkins-data:
